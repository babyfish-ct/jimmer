---
sidebar_position: 7
title: ğŸ”¥ è§¦å‘å™¨
---

import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

Jimmeræ”¯æŒè§¦å‘å™¨ï¼Œç”¨æˆ·å¯ä»¥ç›‘å¬æ•°æ®åº“çš„å˜åŒ–ã€‚

:::tip
è§¦å‘å™¨ä¸ä»…å¯ä»¥å‘ŠçŸ¥å¯¹è±¡çš„å˜æ›´ï¼Œä¹Ÿå¯ä»¥å‘ŠçŸ¥å…³è”çš„å˜æ›´ã€‚
:::

## è§¦å‘å™¨ç±»å‹

### è§¦å‘å™¨åˆ†ç±»

-   BinLogè§¦å‘å™¨
    
    è¿™æ˜¯é»˜è®¤çš„è§¦å‘å™¨ç±»å‹ï¼Œä¸ä¼šå½±å“Jimmeræœ¬èº«ç”Ÿæˆçš„SQLï¼Œå…·æœ‰è¾ƒé«˜æ€§èƒ½ï¼Œåœ¨äº‹åŠ¡æäº¤åè¢«è§¦å‘ï¼Œèƒ½ç›‘å¬ä»»ä½•åŸå› å¯¼è‡´çš„æ•°æ®åº“å˜åŒ–ï¼ŒåŒ…æ‹¬éJimmer APIå¼•èµ·çš„æ•°æ®å’Œå˜åŒ–ï¼›ä½†éœ€è¦åº•å±‚æ•°æ®åº“æ”¯æŒbinlogã€‚

-   Transactionè§¦å‘å™¨

    è¯¥è§¦å‘å™¨ä¸æ— éœ€åº•å±‚æ•°æ®åº“ï¼Œåœ¨äº‹åŠ¡æäº¤å‰è¢«è§¦å‘ï¼›å·¥ä½œæœºåˆ¶å’Œ[Alibaba Seataçš„ATæ¨¡å¼](https://seata.io/zh-cn/docs/dev/mode/at-mode.html)ç±»ä¼¼ï¼Œä¼šåœ¨ä¿®æ”¹è¿‡ç¨‹ä¸­ç”Ÿæˆé¢å¤–çš„æŸ¥è¯¢è¯­å¥ï¼Œå¯¹ä¿®æ”¹æ€§èƒ½æœ‰ä¸€å®šå½±å“ï¼Œä¹Ÿåªèƒ½ç›‘å¬å› Jimmer APIå¯¼è‡´çš„æ•°æ®åº“çš„å˜åŒ–ã€‚

ä¸¤ç§è§¦å‘å™¨çš„åŒºåˆ«å¦‚ä¸‹

||BinLogè§¦å‘å™¨|Transactionè§¦å‘å™¨|
|---|---|---|
|è§¦å‘æ—¶æœº|äº‹åŠ¡æäº¤å|äº‹åŠ¡æäº¤å‰|
|æ€§èƒ½|é«˜|ä½|
|å¯ç›‘å¬çš„æ•°æ®åº“å˜åŒ–|ä»»ä½•åŸå› å¯¼è‡´çš„æ•°æ®åº“å˜åŒ–|ä»…å› å½“å‰åº”ç”¨è°ƒç”¨Jimmer APIå¯¼è‡´çš„æ•°æ®åº“å˜åŒ–|
|æ•°æ®åº“è¦æ±‚|æ”¯æŒä¸”å¯ç”¨binlog|æ— ä»»ä½•è¦æ±‚|
|å·¥ä½œåŸç†|åˆ©ç”¨ç¬¬ä¸‰æ–¹æŠ€æœ¯å°†æ•°æ®åº“binlogå˜æ›´æ¨é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼ŒJimmeråº”ç”¨ç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—|Jimmerçš„ä»»ä½•ä¿®æ”¹æ“ä½œAPIå‡è‡ªåŠ¨æ¤å…¥é¢å¤–çš„SQLæŸ¥è¯¢ä»¥æ‰¾å¯»æ•°æ®å˜æ›´ï¼Œå’Œ[Alibaba Seataçš„ATæ¨¡å¼](https://seata.io/zh-cn/docs/dev/mode/at-mode.html)ç±»ä¼¼|

é™¤äº†è¿™ä¸ªè¡¨æ ¼ä¸­çš„åŒºåˆ«å¤–ï¼Œä¸¤ç§è§¦å‘å™¨ä¸ºç”¨æˆ·æä¾›çš„é€šçŸ¥æ•°æ®å®Œå…¨ç›¸åŒã€‚

### æ¨èç”¨æ³•

-   BinLogè§¦å‘å™¨

    BinLogè§¦å‘å™¨åœ¨äº‹åŠ¡æäº¤åè§¦å‘ï¼Œé¢å¯¹æ— æ³•æ›´æ”¹çš„æ—¢å®šäº‹å®ã€‚
    
    å³ï¼ŒBinLogè§¦å‘å™¨å¯¹åŸäº‹åŠ¡æ¯«æ— å½±å“ï¼Œè¢«å…è®¸åšè€—æ—¶æ“ä½œã€‚æ‰€ä»¥é€‚åˆåœ¨å…¶å¤„ç†é€»è¾‘ä¸­æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œå°¤å…¶æ˜¯è¿™äº›ä»»åŠ¡

    - ç¼“å­˜ä¸€è‡´æ€§ç»´æŠ¤
    - å¼‚æ„æ•°æ®æºåŒæ­¥
    - ä»¥å¼‚æ­¥æ–¹å¼å‘å…¶å®ƒå¾®æœåŠ¡å‘é€æ¶ˆæ¯

-   Transactionè§¦å‘å™¨

    Transactionè§¦å‘å™¨åœ¨äº‹åŠ¡æäº¤å‰è§¦å‘ï¼Œå…¶å¤„ç†é€»è¾‘ä¼šç›´æ¥æ¤å…¥å½“å‰äº‹åŠ¡ã€‚
    
    å¦‚æœå…¶äº‹ä»¶å¤„ç†é€»è¾‘å¼‚å¸¸ï¼Œä¼šå¯¼è‡´å½“å‰ä¸šåŠ¡ä¿®æ”¹å¤±è´¥ï¼›å¦‚æœå…¶å¤„ç†é€»è¾‘ä¸èƒ½å¾ˆå¿«å®Œæˆï¼Œä¼šå¯¼è‡´å½“å‰äº‹åŠ¡é•¿æ—¶é—´ä¸é‡Šæ”¾èµ„æºã€‚

    å› æ­¤ï¼ŒTransactionè§¦å‘å™¨é€‚åˆåœ¨å½“å‰äº‹åŠ¡ä¸­è¿½åŠ æ›´å¤šçš„ä¿®æ”¹è¡Œä¸ºï¼Œä¸ä¼šç ´ååŸå­æ€§ã€‚
    
    é€‚åˆåœ¨æ•°æ®åº“å‘ç”Ÿå˜åŒ–æ—¶é€šè¿‡æ·»åŠ é¢å¤–çš„ä¿®æ”¹æ¥å®ç°é€šç”¨æ€§å¾ˆå¼ºçš„éƒ¨åˆ†ä¸šåŠ¡é€»è¾‘ã€‚

## è®¾ç½®è§¦å‘å™¨ç±»å‹

### æ¦‚å¿µ

åœ¨è®¨è®ºè®¾ç½®è§¦å‘å™¨ç±»å‹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆçœ‹å¼€å‘äººå‘˜å¦‚ä½•ä½¿ç”¨è§¦å‘å™¨
-   `sqlClient.getTriggers()`æˆ–`sqlClient.getTriggers(false)`:
    ä¼˜å…ˆè¿”å›BinLogè§¦å‘å™¨ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å›Transactionè§¦å‘å™¨ã€‚

-   `sqlClient.getTriggers(true)`:
    æ˜ç¡®è¿”å›Transactionè§¦å‘å™¨ï¼Œå¦‚æœæ²¡æœ‰ï¼ŒæŠ›å‡ºå¼‚å¸¸ã€‚

ä¸ºäº†å½±å“åç»­ç”¨æˆ·é€šè¿‡`sqlClient.getTriggers`èƒ½è·å–çš„è§¦å‘å™¨ç±»å‹ï¼Œéœ€è¦åœ¨æ„å»ºSqlClientæ—¶æŒ‡å®šTriggerTypeã€‚

TriggerTypeæœ‰ä¸‰ä¸ªå–å€¼

-   BINLOG_ONLY:

    ä»…æ”¯æŒBinLogè§¦å‘å™¨ï¼Œè¿™æ˜¯é»˜è®¤é…ç½®ã€‚
    - `sqlClient.getTriggers()`å’Œ`sqlClient.getTriggers(false)`è¿”å›BinLogè§¦å‘å™¨å¯¹è±¡
    - `sqlClient.getTriggers(true)`ä¼šå¼‚å¸¸ï¼Œæ— æ³•è¿”å›Transactionè§¦å‘å™¨å¯¹è±¡

-   TRANSACTION_ONLY:

    ä»…æ”¯æŒTransactionè§¦å‘å™¨ã€‚
    æ— è®º`sqlClient.getTriggers`çš„å‚æ•°ä¸ºä½•ï¼Œéƒ½ä¼šè¿”å›åŒä¸€ä¸ªTransactionè§¦å‘å™¨å¯¹è±¡

-   BOTH:

    åŒæ—¶æ”¯æŒBinLogè§¦å‘å™¨ä½•Transactionè§¦å‘å™¨ã€‚
    - `sqlClient.getTriggers()`å’Œ`sqlClient.getTriggers(false)`è¿”å›BinLogè§¦å‘å™¨å¯¹è±¡
    - `sqlClient.getTriggers(true)`è¿”å›Transactionè§¦å‘å™¨å¯¹è±¡

è¿™é‡Œï¼Œç”¨ä¸€å¼ è¡¨æ ¼æ¥å¯¹æ¯”ä¸‰ç§æƒ…å†µ

<table>
    <thead>
        <tr>
            <th>è§¦å‘å™¨ç±»å‹</th>
            <th>getTriggers(false)</th>
            <th>getTriggers(true)</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>BINLOG_ONLY</td>
            <td>BinLog Triggersä¸“ç”¨å¯¹è±¡</td>
            <td><span style={{color:'red'}}>æŠ›å‡ºå¼‚å¸¸</span></td>
        </tr>
        <tr>
            <td>TRANSACTION_ONLY</td>
            <td colspan="2"><center><b>å…±äº«çš„</b>Transaction Triggerså¯¹è±¡</center></td>
        </tr>
        <tr>
            <td>BOTH</td>
            <td>BinLog Triggersä¸“ç”¨å¯¹è±¡</td>
            <td>Transaction Triggersä¸“ç”¨å¯¹è±¡</td>
        </tr>
    </tbody>
</table>

## Q & A

-   **Q**: ä¸ºä»€ä¹ˆé»˜è®¤`BINLOG_ONLY`æ¨¡å¼?

    **A**: Transactionè§¦å‘å™¨ä¼šåœ¨æ‰€æœ‰ä¿å­˜è¡Œä¸ºä¸­æ¤å…¥é¢å¤–çš„æŸ¥è¯¢ç”¨äºæ¨¡æ‹Ÿè§¦å‘å™¨ï¼Œå¯¹æ€§èƒ½æœ‰å½±å“ï¼Œé»˜è®¤ä¸æ”¯æŒã€‚

-   **Q**: ä¸ºä»€ä¹ˆ`TRANSACTION_ONLY`æ¨¡å¼ä¸‹ï¼Œä¸¤ç§è§¦å‘å™¨APIå…±äº«åŒä¸€ä¸ªå¯¹è±¡?

    **A**: Jimmerå†…ç½®çš„ç¼“å­˜ä¸€è‡´æ€§ç­–ç•¥ï¼Œä¸€å®šä½¿ç”¨`sqlClient.getTriggers(false)`ï¼Œå¼€å‘äººå‘˜æ— æ³•æ”¹å˜ã€‚

    è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œè®©ç¼“å­˜ä¸€è‡´æ€§ç»´æŠ¤å·¥ä½œä¸å½±å“ä¿®æ”¹äº‹åŠ¡ï¼Œåœ¨äº‹åŠ¡æäº¤åæ‰å¼€å§‹æ‰§è¡Œã€‚å› æ­¤ï¼ŒåŸå§‹äº‹åŠ¡ä¸ä¼šè¢«æ‹‰é•¿ï¼Œä»è€Œå¿«é€Ÿç»“æŸé‡Šæ”¾é”èµ„æºã€‚

    ä½†æ˜¯ï¼Œå¹¶éæ‰€æœ‰æ•°æ®åº“äº§å“éƒ½æ”¯æŒbinlogã€‚è¿™æ—¶ï¼Œ`getTriggers(false)`è¿”å›Transactionè§¦å‘å™¨å¯¹è±¡ï¼Œå†’å……BinLogè§¦å‘å™¨å¯¹è±¡ï¼Œæ¥æ‰‹åŸæœ¬åº”è¯¥ç”±BinLogè§¦å‘å™¨è´Ÿè´£çš„ç¼“å­˜ä¸€è‡´æ€§ç»´æŠ¤å·¥ä½œã€‚

    ä¹Ÿå°±æ˜¯è¯´ï¼Œ`TRANSACTION_ONLY`æ˜¯ä¸ºä¸æ”¯æŒbinlogçš„æ•°æ®åº“è®¾è®¡çš„ï¼Œ**è¿™æ˜¯é‡‡ç”¨è¯¥æ¨¡å¼çš„å”¯ä¸€ç†ç”±**ã€‚

-   **Q**: `BOTH`æ¨¡å¼ä¸‹ï¼Œå­˜åœ¨ä¸¤ä¸ªä¸åŒçš„è§¦å‘å™¨APIå¯¹è±¡ï¼Œæ˜¯ä¸æ˜¯è¡¨ç¤ºä»»ä½•ä¿®æ”¹éƒ½æœ‰ä¸¤æ¬¡å“åº”æœºä¼šï¼Ÿ

    **A**: æ˜¯çš„ï¼Œè€Œä¸”è¿™æ˜¯ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ã€‚

    å’ŒJimmerå†…ç½®çš„ç¼“å­˜ä¸€è‡´æ€§æœºåˆ¶å¿…é¡»ç”±`sqlClient.getTriggers(false)`é©±åŠ¨ä¸åŒï¼›ç”¨æˆ·çš„ä¸šåŠ¡ä»£ç æ²¡æœ‰è¿™ä¸ªé™åˆ¶ï¼Œå¼€å‘äººå‘˜å¯ä»¥è‡ªç”±å†³å®šæŸä¸ªå¤„ç†é€»è¾‘ç©¶ç«Ÿæ³¨å†Œåˆ°`sqlClient.getTriggers(false)`è¿˜æ˜¯`sqlClient.getTriggers(true)`ï¼Œç”šè‡³åŒæ—¶å‘äºŒè€…æ³¨å†Œã€‚

    -   å¦‚æœå¼€å‘äººå‘˜çš„äº‹ä»¶å“åº”é€»è¾‘åŒ…å«ä¸€äº›æ•°æ®è”åŠ¨ä¿®æ”¹ï¼Œå¿…é¡»å‚ä¸å½“å‰äº‹åŠ¡çš„åŸå­æ€§ä½œç”¨åŸŸï¼Œå°±åº”è¯¥é€‰æ‹©å°†å¤„ç†é€»è¾‘æ³¨å†Œåˆ°`sqlClient.getTriggers(true)`

    -   å¦‚æœå¼€å‘äººå‘˜çš„äº‹ä»¶å“åº”é€»è¾‘æ²¡å¿…è¦å‚ä¸å½“å‰äº‹åŠ¡ï¼Œå°±åº”è¯¥é€‰æ‹©å°†å¤„ç†é€»è¾‘æ³¨å†Œåˆ°`sqlClient.getTriggers(false)`ï¼Œè®©å½“å‰äº‹åŠ¡å°½å¿«ç»“æŸï¼Œå°½å¿«é‡Šæ”¾é”èµ„æº

    -   å¦‚æœå¼€å‘äººå‘˜çš„äº‹ä»¶å“åº”é€»è¾‘åŒæ—¶åŒ…å«ä»¥ä¸Šä¸¤ç§æƒ…å†µï¼Œå°±åº”è¯¥å°†å¤„ç†é€»è¾‘ä¸€åˆ†ä¸ºäºŒï¼Œç„¶ååˆ†åˆ«æ³¨å†Œåˆ°ä¸¤ç§è§¦å‘å™¨ä¸Šã€‚

        :::caution
        å¦‚æœå¼€å‘äººå‘˜ä¸ºä¸¤ç§è§¦å‘å™¨æ³¨å†Œäº†åŒä¸€ä¸ªäº‹ä»¶å“åº”å›è°ƒï¼Œé‚£ä¹ˆæ¯æ¬¡äº‹ä»¶é€šçŸ¥æ—¶è¿™ä¸ªå›è°ƒçš„ç¡®ä¼šè¢«æ‰§è¡Œä¸¤æ¬¡ã€‚

        è¿™æ—¶ï¼ŒåŒºåˆ†ä¸¤æ¬¡è°ƒç”¨å°±éå¸¸é‡è¦äº†ã€‚å›è°ƒæ–¹æ³•çš„å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯ä»¥è·å–JDBCè¿æ¥å¯¹è±¡ï¼Œå…¶å€¼æ˜¯å¦ä¸ºnullå¯ç”¨ä½œåŒºåˆ†äºŒè€…çš„æ ‡å‡†:
        -   énullï¼Œç¬¬ä¸€æ¬¡å›è°ƒï¼Œç”±Transaction Triggerå¼•èµ·
        -   nullï¼Œç¬¬äºŒæ¬¡å›è°ƒï¼Œç”±BinLog Triggerå¼•èµ·
        :::

-   **Q**: å¯¹äºä¸æ”¯æŒbinlogçš„æ•°æ®åº“è€Œè¨€ï¼Œå…¶ç¼“å­˜ä¸€è‡´æ€§æ¸…ç†æ˜¯ä¸æ˜¯æ— æ³•åœ¨äº‹åŠ¡æäº¤ååšï¼Ÿ

    **A**: å¹¶éå¦‚æ­¤ï¼Œå¦‚æœå¼€å‘äººå‘˜æ„¿æ„ä¼˜åŒ–ï¼Œå¯ä»¥åšåˆ°ã€‚

    è¯šç„¶ï¼Œè¿™ç§æ•°æ®åº“æ— æ³•æ”¯æŒBinLogè§¦å‘å™¨ï¼Œé‡‡ç”¨Transactionè§¦å‘å™¨åœ¨äº‹åŠ¡ç”Ÿå‘½å‘¨æœŸå†…å¾—åˆ°æ•°æ®å˜æ›´é€šçŸ¥æ˜¯å”¯ä¸€å¯è¡Œçš„æ–¹æ³•ã€‚

    ç„¶è€Œï¼Œä¸å¹¶æ˜¯æ”¶åˆ°é€šçŸ¥åï¼Œå¿…é¡»é©¬ä¸Šæ‰§è¡Œç¼“å­˜æ¸…ç†å·¥ä½œï¼Œå› ä¸ºredisè¿™ç§è¿œç¨‹ç¼“å­˜çš„æ¸…ç†è¡Œä¸ºæœ‰ç½‘ç»œé€šä¿¡æˆæœ¬ï¼Œä¹Ÿæœ‰é€šè®¯å¤±è´¥çš„å¯èƒ½ï¼Œè¿™æ ·åšä¼šå¯¼è‡´æœ¬åœ°äº‹åŠ¡è¢«æ‹–é•¿ç”šè‡³å¤±è´¥ã€‚

    Jimmerçš„ç¼“å­˜ç³»ç»Ÿæ”¯æŒè‡ªå®šä¹‰CacheOperatorï¼Œé€šè¿‡è‡ªå®šä¹‰CacheOperatorï¼Œç”¨æˆ·å¯ä»¥è¦†ç›–ç¼“å­˜ç³»ç»Ÿçš„åˆ é™¤è¡Œä¸ºï¼Œå°†ç¼“å­˜åˆ é™¤ä»»åŠ¡è®°å½•ä¸‹æ¥ä½†ä¸é©¬ä¸Šæ‰§è¡Œï¼Œç­‰äº‹åŠ¡æäº¤åå†çœŸæ­£çš„ç¼“å­˜æ¸…ç†ã€‚

    - ä¸éœ€è¦å¯é æ€§çš„åšæ³•
        1. è‡ªå®šä¹‰CacheOperatorå¹¶ä¸ç«‹å³æ¸…ç†ç¼“å­˜ï¼Œè€Œæ˜¯ç”¨ThreadLocalè®°å½•è¦åˆ é™¤çš„ç¼“å­˜çš„é”®ã€‚
        2. åœ¨Springçš„`After commit`äº‹ä»¶ä¸­ï¼Œé›†ä¸­æ¸…ç†ç¼“å­˜ã€‚

    - éœ€è¦å¯é æ€§çš„åšæ³•
        1. è‡ªå®šä¹‰CacheOperatorå¹¶ä¸ç«‹å³æ¸…ç†ç¼“å­˜ï¼Œè€Œæ˜¯ç”¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­ä¸€ä¸ªæœ¬åœ°äº‹ä»¶è¡¨è®°å½•è¦åˆ é™¤çš„ç¼“å­˜çš„é”®ã€‚
        3. åœ¨Springçš„`After Commit`äº‹ä»¶ä¸­ï¼Œä»æœ¬åœ°äº‹ä»¶è¡¨ä¸­å–æ•°æ®ï¼Œæ¸…ç†ç¼“å­˜ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ é™¤æœ¬åœ°äº‹ä»¶è¡¨çš„æ•°æ®ã€‚
        4. ç”¨ä¸€ä¸ªè½®è¯¢æœåŠ¡ï¼Œä¸ºç¬¬2æ­¥çš„å¤±è´¥å…œåº•ã€‚

        :::tip
        å¹¸è¿çš„æ˜¯ï¼Œå¯¹äºè§¦å‘å™¨çš„ç±»å‹ä¸º`TRANSACTION_ONLY`è¿™ç§æƒ…å†µï¼ŒJimmerçš„Spring Boot Starterå·²ç»è¿™æ ·å®ç°äº†ã€‚è¯·å‚è§[ç¼“å­˜ä¸€è‡´æ€§/Transactionè§¦å‘å™¨](../cache/consistency#transactionè§¦å‘å™¨çš„ä¸€è‡´æ€§)
        :::

### ä½¿ç”¨Jimmer Spring Boot Starter

å¦‚æœä½¿ç”¨SpringBoot Starterï¼Œè®¾ç½®è§¦å‘å™¨ç±»å‹éå¸¸ç®€å•ã€‚

åœ¨`application.properties`æˆ–`applicaion.yml`ä¸­æ·»åŠ ä¸€ä¸ªé…ç½®å³å¯ã€‚å…¶åç§°ä¸º`jimmer.trigger-type`ï¼Œå…¶å€¼ä¸º`BINLOG_ONLY` | `TRANSACTION_ONLY` | `BOTH`ã€‚

### ä¸ä½¿ç”¨Jimmer Spring Boot Starter

<Tabs groupId="language">
<TabItem value="java" label="Java">

```java
JSqlClient sqlClient = JSqlClient
    .newBuilder()
    // highlight-next-line
    .setTriggerType(TriggerType.BOTH)
    ...çœç•¥å…¶ä»–é…ç½®...
    .builde();
```

</TabItem>
<TabItem value="kotlin" label="Kotlin">

```kotlin
javax.sql.DataSource dataSource = ...;

var sqlClient = newKSqlClient {
    // highlight-next-line
    setTriggerType(TriggerType.BOTH)
    ...çœç•¥å…¶ä»–é…ç½®...
}
```

</TabItem>
</Tabs>

## BinLogè§¦å‘å™¨å¼€å‘å·¥ä½œ

å’ŒTransactionè§¦å‘å™¨ä¸åŒï¼ŒBinLogè§¦å‘å™¨éœ€è¦é‡‡ç”¨ç¬¬ä¸‰æ–¹æŠ€æœ¯å°†æ•°æ®åº“binlogå˜æ›´æ¨é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¹¶è®©åº”ç”¨ç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—ã€‚

å› æ­¤ï¼Œä»…ä»…åœ¨æ„å»ºSqlClientå¯¹è±¡æ—¶æŠŠTriggerTypeæŒ‡å®šä¸º`BINLOG_ONLY`(é»˜è®¤è¡Œä¸º)æˆ–`BOTH`æ˜¯ä¸å¤Ÿçš„ã€‚

æ¶ˆæ¯é˜Ÿåˆ—æœ‰å¤šæœ‰é€‰æ‹©ï¼Œä¾‹å¦‚Kafkaå’ŒRabbitMQï¼›æŠŠæ•°æ®åº“binlogçš„å¢é‡æ¨é€åˆ°æ¶ˆæ¯é˜Ÿåˆ—çš„ç¬¬ä¸‰æ–¹æŠ€æœ¯ä¹Ÿæœ‰å¤šç§é€‰æ‹©ï¼Œä¾‹å¦‚MaxWellã€Debeziumã€Canalå’ŒDataBusã€‚

Jimmerå¯¹è¿™ç±»é€‰æ‹©æœªåšä»»ä½•é™åˆ¶ã€‚ä½†ä¸ºç®€åŒ–é—®é¢˜è®¨è®ºï¼Œæœ¬æ–‡å‡è®¾æ¶ˆæ¯é˜Ÿåˆ—é€‰ç”¨Kafkaï¼Œæ¨é€æŠ€æœ¯é‡‡ç”¨Maxwell *(MySQL)* å’ŒDebezium *(Postgres)*ã€‚

:::caution
ç”±äºDebeziumæœ¬èº«æ˜¯kafka-connectorï¼Œæ‰€ä»¥ï¼Œä½¿ç”¨Debeziumå¿…ç„¶å¯¼è‡´æ¶ˆæ¯é˜Ÿåˆ—æ˜¯Kafka
:::

### å¤–éƒ¨ç¯å¢ƒæ­å»º

åœ¨å¼€å‘ä¹‹å‰ï¼Œå…ˆè¦å…ˆå®‰è£…ç¯å¢ƒï¼ŒåŒ…æ‹¬æ•°æ®åº“ã€Kafkaã€ä»¥åŠMaxwellæˆ–Debeziumã€‚

-   Maxwell

    1.  è¿›å…¥[example/env-with-cache/maxwell](https://github.com/babyfish-ct/jimmer/blob/main/example/env-with-cache/maxwell)æ‰€å¯¹åº”çš„`git clone`åæœ¬åœ°ç›®å½•

    2.  æ‰§è¡Œ
        ```sh
        bash ./install.sh
        ```
-   Debezium

    1.  è¿›å…¥[example/env-with-cache/debezium](https://github.com/babyfish-ct/jimmer/blob/main/example/env-with-cache/debezium)æ‰€å¯¹åº”çš„`git clone`åæœ¬åœ°ç›®å½•

    2.  æ‰§è¡Œ
        ```sh
        bash ./install.sh
        ```

### ç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—

æ— è®ºæ˜¯é€‰ç”¨ä¸åŒçš„æ•°æ®åº“ *(MySQLæˆ–Postgres)*ï¼Œè¿˜æ˜¯é€‰ç”¨ä¸åŒå˜æ›´æ¨é€æŠ€æœ¯ *(Maxwellæˆ–Debezium)*ï¼Œéƒ½ä¼šå¯¼è‡´ç›‘å¬ä»£ç å‡ºç°å·®å¼‚ã€‚

ä½†æ— è®ºå¦‚ä½•ï¼Œç”¨æˆ·ä»£ç éƒ½æ˜¯å¤§åŒå°å¼‚çš„ï¼Œåˆ†ä¸ºå¦‚ä¸‹4ä¸ªæ­¥éª¤

1.  ç›‘å¬æ¶ˆæ¯é˜Ÿåˆ—ï¼Œå¾—åˆ°æ¶ˆæ¯ä½“çš„å­—ç¬¦ä¸²

2.  ä½¿ç”¨[ObjectMapper.readTree](https://fasterxml.github.io/jackson-databind/javadoc/2.7/com/fasterxml/jackson/databind/ObjectMapper.html#readTree(java.lang.String))å¯¹æ¶ˆæ¯æ–‡æœ¬è¿›è¡Œå¼±ç±»å‹è§£æ

    :::info
    æ‰€è°“å¼±ç±»å‹è§£æï¼ŒæŒ‡å¾—åˆ°çš„ç±»å‹ä¸º[JsonNode](https://fasterxml.github.io/jackson-databind/javadoc/2.7/com/fasterxml/jackson/databind/JsonNode.html)ï¼Œå’Œä¸šåŠ¡ç³»ç»Ÿçš„ç±»å‹æ— å…³
    :::

3.  è§‚å¯Ÿ[JsonNode](https://fasterxml.github.io/jackson-databind/javadoc/2.7/com/fasterxml/jackson/databind/JsonNode.html)çš„å†…å®¹ï¼Œæå–å‡º

    -   è¡¨åï¼Œè®°ä¸º`tableName`
    
    -   ä¿®æ”¹å‰æ—§æ•°æ®çš„çš„å­[JsonNode](https://fasterxml.github.io/jackson-databind/javadoc/2.7/com/fasterxml/jackson/databind/JsonNode.html)ï¼Œè®°ä¸º`oldJsonNode`
    
        > å¯¹äºæ’å…¥æ“ä½œè€Œè¨€ï¼Œ`oldJsonNode`ä¸ºnull

    -   ä¿®æ”¹åæ–°æ•°æ®çš„çš„å­[JsonNode](https://fasterxml.github.io/jackson-databind/javadoc/2.7/com/fasterxml/jackson/databind/JsonNode.html)ï¼Œè®°ä¸º`newJsonNode`
    
        > å¯¹äºåˆ é™¤æ“ä½œè€Œè¨€ï¼Œ`newJsonNode`ä¸ºnull

    :::info
    æ•°æ®åº“å’Œå˜æ›´æ¨é€æŠ€æœ¯çš„ä¸åŒé€‰æ‹©å¯¼è‡´çš„ç›‘å¬ä»£ç å˜åŒ–ï¼Œå°±æ˜¯æŒ‡è¿™ä¸ªæ­¥éª¤ã€‚ç„¶è€Œï¼Œè¿™å¹¶ä¸éš¾ï¼Œå¯¹æ¶ˆæ¯å†…å®¹ç¨åŠ è§‚å¯Ÿå³å¯è½»æ¾å®ç°ã€‚
    :::

4.  ä»¥`tableName`ã€`oldJsonNode`å’Œ`newJsonNode`è°ƒç”¨`JSqlClient.getBinLog().accept`æˆ–`KSqlCient.binLog.accept`

ä¸‹é¢çš„ä¾‹å­ï¼Œåˆ†åˆ«æ¼”ç¤º`MySQL + Maxwell`å’Œ`Postgres + Debezium`ä¸¤ç§æƒ…å†µã€‚

-   MySQL + Maxwell

    å¯¹äº`MySQL + Maxwell`è¿™ç§æƒ…å†µï¼Œæ¶ˆæ¯æ ¼å¼é€šå¸¸æ˜¯è¿™æ ·çš„

    ```json
    {
        "database":"jimmer_demo",
        "table":"book",
        "type":"update",
        "ts":1688592724,
        "xid":11790,
        "commit":true,
        "data":{
            "id":1,
            "name":"Learning GraphQL",
            "edition":1,
            "price":50,
            "store_id":1,
            "tenant":"a",
            "created_time":"2023-07-05 20:21:00",
            "modified_time":"2023-07-05 20:21:00"
        },
        "old":{
            "store_id":2
        }
    }
    ```

    ç¨åŠ è§‚å¯Ÿ *ï¼ˆå»ºè®®inertã€updateã€deleteçš„æ¶ˆæ¯éƒ½çœ‹ä¸€ä¸‹ï¼‰* åï¼Œä¸éš¾å®ç°å¦‚ä¸‹æ¶ˆæ¯ç›‘å¬ä»£ç 

    <Tabs groupId="language">
    <TabItem value="java" label="Java">

    ```java title="MaxwellListener.java"
    @Component
    public class MaxwellListener {

        private static final ObjectMapper MAPPER = new ObjectMapper();

        private final Caches caches;

        public MaxwellListener(JSqlClient sqlClient) {
            this.caches = sqlClient.getCaches();
        }

        @KafkaListener(topics = "maxwell")
        public void onMaxwellEvent(
                String json,
                Acknowledgment acknowledgment
        ) throws JsonProcessingException {
            JsonNode node = MAPPER.readTree(json);
            String tableName = node.get("table").asText();
            String type = node.get("type").asText();
            JsonNode data = node.get("data");
            switch (type) {
                case "insert":
                    binLog.accept(tableName, null, data);
                    break;
                case "update":
                    binLog.accept(tableName, node.get("old"), data);
                    break;
                case "delete":
                    binLog.accept(tableName, data, null);
                    break;
            }
            acknowledgment.acknowledge();
        }
    }
    ```

    </TabItem>
    <TabItem value="kotlin" label="Kotlin">

    ```kotlin  title="MaxwellListener.kt"
    @Component
    class MaxwellListener(sqlClient: KSqlClient) {

        private val caches: KCaches = sqlClient.caches

        @KafkaListener(topics = ["maxwell"])
        fun onMaxwellEvent(
            json: String,
            acknowledgment: Acknowledgment
        ) {
            val node = MAPPER.readTree(json)
            val tableName = node["table"].asText()
            val type = node["type"].asText()
            val data = node["data"]
            when (type) {
                "insert" ->
                    binLog.accept(tableName, null, data)
                "update" ->
                    binLog.accept(tableName, node["old"], data)
                "delete" ->
                    binLog.accept(tableName, data, null)
            }
            acknowledgment.acknowledge()
        }

        companion object {
            @JvmStatic
            private val MAPPER = ObjectMapper()
        }
    }
    ```

    </TabItem>
    </Tabs>

-   Postgres + Debezium

    å¯¹äº`Postgres + Debezium`è¿™ç§æƒ…å†µï¼Œæ¶ˆæ¯æ ¼å¼é€šå¸¸æ˜¯è¿™æ ·çš„

    ```json
    {
        "before": {
            "id": 10,
            "name": "GraphQL in Action",
            "edition": 1,
            "price": "H0A=",
            "store_id": 1,
            "tenant": "b",
            "created_time": 1688590805971294,
            "modified_time": 1688590805971294
        },
        "after": {
            ...ç•¥...
        },
        "source": {
            "table": "book",
            ...ç•¥...
        },
        ...ç•¥...
    }
    ```

    æˆ‘ä»¬å‘ç°äº†ä¸€äº›éš¾ç‚¹ï¼Œå¹¶éæ‰€æœ‰æ•°æ®éƒ½å¯ä»¥è¢«Jimmerçš„BinLogæ˜ å°„æœºåˆ¶ç›´æ¥è¯†åˆ«å’Œè½¬åŒ–

    -   `BigDecimal`ç±»å‹ *(Postgresä¸­ä¸º`NUMERIC(M[, D])`)* çš„å±æ€§ *(æœ¬ä¾‹ä¸­ä¸º`Book.price`)*ï¼Œè¢«æ˜¾ç¤ºæˆäº†Base64ç¼–ç  *(æœ¬ä¾‹ä¸­ä¸º`H0A=`)*

        è¯¥Base64å­—ç¬¦ä¸²æ˜¯[org.apache.kafka.connect.data.Decimal](https://kafka.apache.org/0100/javadoc/org/apache/kafka/connect/data/Decimal.html)å¤„ç†åå¾—åˆ°çš„ä¿¡æ¯

    -   `LocalDateTime`ç±»å‹ *(Postgresä¸­ä¸ºTIMESTAMP)* çš„å±æ€§è¢«æ˜¾ç¤ºä¸ºæ•°å­—

    :::info
    Debeziumçš„æ–‡æ¡£ä¼šå¯¹è¯¦ç»†ä»‹ç»å®ƒçš„å„ç§connectoræ˜¯å¦‚ä½•å¤„ç†æŸäº›ç‰¹æ®Šæ•°æ®çš„ï¼Œæ¯”å¦‚[pg-connectoræ˜¯å¦‚ä½•å¤„ç†decimalçš„](https://debezium.io/documentation/reference/stable/connectors/postgresql.html#postgresql-decimal-types)ã€‚

    Debeziumä¸­å„ç§connectoréƒ½ä¼šæä¾›ä¸°å¯Œçš„é…ç½®ï¼Œå…¶ä¸­æœ‰ä¸€äº›å¯ä»¥ç”¨äºæ”¹å˜é»˜è®¤çš„æ•°æ®å¤„ç†æ–¹å¼ï¼Œæ¯”å¦‚[æ”¹å˜decimalæ•°æ®çš„å¤„ç†æ–¹å¼](https://debezium.io/documentation/reference/stable/connectors/postgresql.html#postgresql-property-decimal-handling-mode)ï¼Œä»è€Œé¿å…å‡ºç°ç±»ä¼¼çš„é—®é¢˜ã€‚

    ç„¶è€Œï¼ŒDebeziumçš„connectoré€šå¸¸ä¸ºæ‰€æœ‰ç³»ç»Ÿæä¾›æœåŠ¡ï¼Œå¹¶ä¸ä¼šåˆ»æ„â€œè®¨å¥½â€æŸä¸ªåº”ç”¨ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½å‡è®¾å…¶é…ç½®æ€»èƒ½ä¿è¯è¾“å‡ºJimmerå¯ä»¥ç›´æ¥ç†è§£çš„æ•°æ®ã€‚

    Jimmeré™„å¸¦çš„ä¾‹å­æ•…æ„ä¸å¯¹Debezium connectorè¿›è¡Œé…åˆ¶ï¼Œè®©å…¶è¾“å‡ºkafka-connectorç‰¹æœ‰çš„æ•°æ®ï¼Œæ¥ç¤ºèŒƒJimmerå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæœ¬æ–‡åŒæ ·ã€‚
    :::

    <Tabs groupId="language">
    <TabItem value="java" label="Java">

    ```java title="DebeziumCustomizer.java"
    package ...ç•¥...;

    import org.apache.kafka.connect.data.Decimal;
    import org.apache.kafka.connect.data.Schema;
    import org.babyfish.jimmer.sql.runtime.Customizer;
    
    ...çœç•¥å…¶ä»–å¯¼å…¥è¯­å¥...

    @Component
    public class DebeziumCustomizer implements Customizer {

        private static final Schema BOOK_PRICE_SCHEMA =
                // Postgresä¸­`BOOK.PRICE`çš„ç±»å‹æ˜¯`NUMERIC(10, 2)`ï¼Œç²¾åº¦ä¸º2
                Decimal.schema(2);

        @Override
        public void customize(JSqlClient.Builder builder) {
            
            builder.setBinLogPropReader( â¶
                    LocalDateTime.class,
                    (prop, jsonNode) -> {
                        return Instant.ofEpochMilli(
                                jsonNode.asLong() / 1000
                        ).atZone(ZoneId.systemDefault()).toLocalDateTime();
                    }
            );

            builder.setBinLogPropReader(
                    BookProps.PRICE, â·
                    (prop, jsonNode) -> {
                        byte[] bytes = Base64.getDecoder().decode(jsonNode.asText());
                        return Decimal.toLogical(BOOK_PRICE_SCHEMA, bytes);
                    }
            );
        }
    }
    ```

    </TabItem>
    <TabItem value="kotlin" label="Kotlin">

    ```kotlin  title="DebeziumCustomizer.kt"
    package ...ç•¥...

    import org.apache.kafka.connect.data.Decimal
    import org.apache.kafka.connect.data.Schema
    import org.babyfish.jimmer.sql.kt.cfg.KCustomizer
    
    ...çœç•¥å…¶ä»–å¯¼å…¥è¯­å¥...

    @Component
    class DebeziumCustomizer : KCustomizer {

        override fun customize(dsl: KSqlClientDsl) {

            dsl.setBinLogPropReader(
                LocalDateTime::class â¶
            ) { _, jsonNode ->
                Instant.ofEpochMilli(
                    jsonNode.asLong() / 1000
                ).atZone(ZoneId.systemDefault()).toLocalDateTime()
            }

            dsl.setBinLogPropReader(
                Book::price â·
            ) { _, jsonNode ->
                Decimal.toLogical(
                    BOOK_PRICE_SCHEMA,
                    Base64.getDecoder().decode(jsonNode.asText())
                )
            }
        }

        companion object {
            private val BOOK_PRICE_SCHEMA =
                // Postgresä¸­`BOOK.PRICE`çš„ç±»å‹æ˜¯`NUMERIC(10, 2)`ï¼Œç²¾åº¦ä¸º2
                Decimal.schema(2)
        }
    }
    ```

    </TabItem>
    </Tabs>

    `setBinLogPropReader`å…è®¸å¼€å‘äººå‘˜è‡ªå®šä¹‰å¦‚ä½•è§£ææ¶ˆæ¯ä¸­æ— æ³•ç›´æ¥è¯†åˆ«çš„å±æ€§ï¼Œæœ‰ä¸¤ç§ç”¨æ³•

    -   â¶ ç»™å®šè¿”å›ç±»å‹ï¼ŒæŒ‡å®šä¸€ç±»å±æ€§è¯¥å¦‚ä½•è§£æ

    -   â· ç²¾ç¡®å®šä¹‰æŸä¸ªå±æ€§è¯¥å¦‚ä½•è§£æ

    è§£å†³è¿™äº›é—®é¢˜åï¼Œæ¶ˆæ¯ç›‘å¬ä»£ç å°±å¾ˆå®¹æ˜“å®ç°äº†

    <Tabs groupId="language">
    <TabItem value="java" label="Java">

    ```java title="DebeziumListener.java"
    @Component
    public class DebeziumListener {

        private static final ObjectMapper MAPPER = new ObjectMapper();

        private final BinLog binLog;

        public DebeziumListener(JSqlClient sqlClient) {
            this.binLog = sqlClient.getBinLog();
        }

        @KafkaListener(topicPattern = "debezium\\..*")
        public void onDebeziumEvent(
                @Payload(required = false) String json,
                Acknowledgment acknowledgment
        ) throws JsonProcessingException {
            if (json != null) { // Debeziumåœ¨å‘é€æ•°æ®åˆ é™¤æ¶ˆæ¯åä¼šç´§æ¥ç€å‘é€ç©ºæ¶ˆæ¯
                JsonNode node = MAPPER.readTree(json);
                String tableName = node.get("source").get("table").asText();
                binLog.accept(
                        tableName,
                        node.get("before"),
                        node.get("after")
                );
            }
            acknowledgment.acknowledge();
        }
    }
    ```

    </TabItem>
    <TabItem value="kotlin" label="Kotlin">

    ```kotlin  title="DebeziumListener.kt"
    @Component
    class DebeziumListener(sqlClient: KSqlClient) {

        private val binLog: BinLog = sqlClient.binLog

        @KafkaListener(topicPattern = """debezium\..*""")
        fun onDebeziumEvent(
            @Payload(required = false) json: String?,
            acknowledgment: Acknowledgment
        ) {
            if (json !== null) { // Debeziumåœ¨å‘é€æ•°æ®åˆ é™¤æ¶ˆæ¯åä¼šç´§æ¥ç€å‘é€ç©ºæ¶ˆæ¯
                val node: JsonNode = MAPPER.readTree(json)
                val tableName: String = node["source"]["table"].asText()
                binLog.accept(
                    tableName,
                    node["before"],
                    node["after"]
                )
            }
            acknowledgment.acknowledge()
        }

        companion object {
            private val MAPPER = ObjectMapper()
        }
    }
    ```

    </TabItem>
    </Tabs>

## ä½¿ç”¨ç¤ºèŒƒ

å¦‚æœä½¿ç”¨BinLogè§¦å‘å™¨ï¼Œè¯·å…ˆæŒ‰ä¸Šæ–‡æ‰€è¿°ï¼Œå¯ç”¨BinLogè§¦å‘å™¨ã€‚

### æ³¨å†Œå¤„ç†é€»è¾‘

-   ä½¿ç”¨Spring Boot Starter

    å¦‚æœä½¿ç”¨SpringBoot Starterï¼Œè§¦å‘å™¨äº‹ä»¶ä¼šè¢«ä½œä¸ºSpringäº‹ä»¶å‘é€ã€‚
    
    å› æ­¤ï¼Œä½¿ç”¨æ³¨è§£`@org.springframework.context.event.EventListener`å“åº”Springäº‹ä»¶å³å¯

    <Tabs groupId="language">
    <TabItem value="java" label="Java">

    ```java title="DatabaseListener.java"
    @Component
    public class DatabaseListener {

        // highlight-next-line
        @EventListener
        public void onEntityChanged(EntityEvent<?> e) {
            if (e.getImmutableType().getJavaClass() == Book.class) {
                System.out.println("The object `Book` is changed");
                System.out.println("\told: " + e.getOldEntity());
                System.out.println("\tnew: " + e.getNewEntity());
            }
        }

        // highlight-next-line
        @EventListener
        public void onAssociationChanged(AssociationEvent e) {
            if (e.isChanged(BookProps.STORE)) {
                System.out.println("The many-to-one association `Book.store` is changed");
                System.out.println("\tbook id: " + e.getSourceId());
                System.out.println("\tdetached book store id: " + e.getDetachedTargetId());
                System.out.println("\tattached book store id: " + e.getAttachedTargetId());
            } else if (e.isChanged(BookStoreProps.BOOKS)) {
                System.out.println("The one-to-many association `BookStore.books` is changed");
                System.out.println("\tbook store id: " + e.getSourceId());
                System.out.println("\tdetached book id: " + e.getDetachedTargetId());
                System.out.println("\tattached book id: " + e.getAttachedTargetId());
            }
        }
    }
    ```

    </TabItem>
    <TabItem value="kotlin" label="Kotlin">

    ```kotlin title="DatabaseListener.kt"
    @Component
    public class DatabaseListener {

        // highlight-next-line
        @EventListener
        fun onEntityChanged(e: EntityEvent<*>) {
            if (e.ImmutableType.javaClass == Book::class.java) {
                println("The object `Book` is changed")
                println("\told: ${it.oldEntity}")
                println("\tnew: ${it.newEntity}")
            }
        }

        // highlight-next-line
        @EventListener
        fun onAssociationChanged(e: AssociationEvent) {
            if (e.isChanged(Book::store)) {
                pprintln("The many-to-one association `Book.store` is changed")
                println("\tbook id: ${it.sourceId}")
                println("\tdetached book store id: ${it.detachedTargetId}")
                println("\tattached book store id: ${it.attachedTargetId}")
            } else if (e.isChanged(BookStore::books)) {
                println("The one-to-many association `BookStore.books` is changed")
                println("\tbook store id: ${it.sourceId}")
                println("\tdetached book id: ${it.detachedTargetId}")
                println("\tattached book id: ${it.attachedTargetId}")
            }
        }
    }
    ```

    </TabItem>
    </Tabs>

-   ä½¿ç”¨åº•å±‚API

    å¦‚æœä¸é‡‡ç”¨Jimmerçš„SpringBoot starterï¼Œéœ€è¦æ‰‹åŠ¨æ³¨å†Œäº‹ä»¶å“åº”ä»£ç ã€‚

    <Tabs groupId="language">
    <TabItem value="java" label="Java">

    ```java
    // highlight-next-line
    sqlClient.getTriggers().addEntityListener(Book.class, e -> {
        System.out.println("The object `Book` is changed");
        System.out.println("\told: " + e.getOldEntity());
        System.out.println("\tnew: " + e.getNewEntity());
    });
    // highlight-next-line
    sqlClient.getTriggers().addAssociationListener(BookProps.STORE, e -> {
        System.out.println("The many-to-one association `Book.store` is changed");
        System.out.println("\tbook id: " + e.getSourceId());
        System.out.println("\tdetached book store id: " + e.getDetachedTargetId());
        System.out.println("\tattached book store id: " + e.getAttachedTargetId());
    });
    // highlight-next-line
    sqlClient.getTriggers().addAssociationListener(BookStoreProps.BOOKS, e -> {
        System.out.println("The one-to-many association `BookStore.books` is changed");
        System.out.println("\tbook store id: " + e.getSourceId());
        System.out.println("\tdetached book id: " + e.getDetachedTargetId());
        System.out.println("\tattached book id: " + e.getAttachedTargetId());
    });
    ```

    </TabItem>
    <TabItem value="kotlin" label="Kotlin">

    ```kotlin
    // highlight-next-line
    sqlClient.triggers.addEntityListener(Book::class) {
        println("The object `Book` is changed")
        println("\told: ${it.oldEntity}")
        println("\tnew: ${it.newEntity}")
    }
    // highlight-next-line
    sqlClient.triggers.addAssociationListener(Book::store) {
        println("The many-to-one association `Book.store` is changed")
        println("\tbook id: ${it.sourceId}")
        println("\tdetached book store id: ${it.detachedTargetId}")
        println("\tattached book store id: ${it.attachedTargetId}")
    }
    // highlight-next-line
    sqlClient.triggers.addAssociationListener(BookStore::books) {
        println("The one-to-many association `BookStore.books` is changed")
        println("\tbook store id: ${it.sourceId}")
        println("\tdetached book id: ${it.detachedTargetId}")
        println("\tattached book id: ${it.attachedTargetId}")
    }
    ```

    </TabItem>
    </Tabs>

å…¶ä¸­`sqlClient.getTriggers()`æˆ–`sqClient.triggers`ç”¨äºå°†å¤„ç†é€»è¾‘æ³¨å†Œåˆ°é»˜è®¤çš„è§¦å‘å™¨ä¸Šã€‚

ä¹Ÿå¯æŠŠä¸Šé¢ä»£ç ä¸­çš„`sqlClient.getTriggers()`æˆ–`sqClient.triggers`æ›¿æ¢ä¸º**`sqlClient.getTriggers(true)`**ï¼Œè¿™æ ·ï¼Œå¤„ç†é€»è¾‘å°±è¢«æ³¨å†Œåˆ°Transactionè§¦å‘å™¨ä¸Šã€‚

### ä½“éªŒè§¦å‘å™¨

ç°åœ¨ï¼Œæˆ‘ä»¬è§¦å‘äº‹ä»¶ï¼Œä½“éªŒè§¦å‘å™¨ã€‚

BinLogè§¦å‘å™¨å¯ä»¥ç›‘å¬å› ä»»ä½•åŸå› å¯¼è‡´çš„æ•°æ®åº“å˜åŒ–ï¼Œå³ä¾¿ç»•è¿‡åº”ç”¨ç¨‹åºç”¨å…¶ä»–ä»»ä½•æ‰‹æ®µå®ç°æ•°æ®åº“ä¿®æ”¹ï¼Œä¹Ÿå¯ä»¥å‘BinLogè§¦å‘å™¨å‘é€äº‹ä»¶ã€‚

æ¯”å¦‚ï¼Œä½ å¯ä»¥ç›´æ¥ç”¨SQLå·¥å…·æ‰§è¡Œ

```sql
update BOOK set STORE_ID = 2 where ID = 7;
```

ç„¶è€Œï¼Œå¦‚æœè¦å‘Transactionè§¦å‘å™¨å‘é€äº‹ä»¶ï¼Œåˆ™å¿…é¡»é€šè¿‡Jimmerçš„APIä¿®æ”¹æ•°æ®åº“ï¼Œä¾‹å¦‚

<Tabs groupId="language">
<TabItem value="java" label="Java">

```java
BookTable book = BookTable.$;
sqlClient
        .createUpdate(book)
        .set(book.store().id(), 2L)
        .where(book.id().eq(7L))
        .execute();
```

</TabItem>
<TabItem value="kotlin" label="Kotlin">

```kotlin
sqlClient
        .createUpdate(Book::class) {
            set(table.store.id, 2L)
            where(table.id eq 7L)
        }
        .execute()
```

</TabItem>
</Tabs>

æ‰“å°ç»“æœ

```
The object `Book` is changed â¶
	old: {"id":7,"name":"Programming TypeScript","edition":1,"price":47.50,"store":{"id":1}}
	new: {"id":7,"name":"Programming TypeScript","edition":1,"price":47.50,"store":{"id":2}}
The many-to-one association `Book.store` is changed â·
	book id: 7
	detached book store id: 1
	attached book store id: 2
The one-to-many association `BookStore.books` is changed â¸
	book store id: 1
	detached book id: 7
	attached book id: null
The one-to-many association `BookStore.books` is changed â¹
	book store id: 2
	detached book id: null
	attached book id: 7
```

å…¶ä¸­

-   â¶ ä»£è¡¨äº†å¯¹è±¡å˜æ›´äº‹ä»¶

-   â·ã€â¸å’Œâ¹ä»£è¡¨äº†å…³è”å˜æ›´äº‹ä»¶

:::tip
Jimmerè§¦å‘å™¨ä¸ä»…èƒ½æŠŠç®€å•åœ°æŠŠè¡¨çš„å˜æ›´è½¬åŒ–ä¸ºå¯¹è±¡å˜æ›´äº‹ä»¶ï¼Œè¿˜å¯ä»¥æŠŠå¤–é”®çš„å˜åŒ–å’Œä¸­é—´è¡¨çš„å˜åŒ–è½¬åŒ–ä¸ºå…³è”å˜æ›´äº‹ä»¶ã€‚
:::
